# Story 2.1: 任务创建功能

## Status
Draft

## Story
**As a** 项目成员，
**I want** 能够创建新任务，
**so that** 能够记录和管理需要完成的工作。

### 扩展：智能化任务创建（AI 辅助 + 模板 + 批量）
**As a** 项目成员，
**I want** 通过自然语言输入或选择推荐模板，系统自动解析并预填任务字段，可一次创建多条任务，
**so that** 显著减少表单手填时间，满足快速创建任务的需求。

## Acceptance Criteria

1. 用户能够输入任务标题、描述、负责人、截止日期、优先级
2. 系统验证必填字段，确保任务信息完整
3. 任务创建成功后显示确认信息
4. 新任务自动保存到数据库
5. 任务创建后能够立即在任务列表中看到
6. 自然语言解析：输入如“本周五前完成项目A评审，指派张三，优先级高”，系统可解析并预填标题、截止日期、负责人、优先级；用户可修改后再创建
7. 模板建议：基于最近使用/项目上下文，至少提供3个模板建议；选择后自动填充可编辑
8. 批量创建：支持多行文本一次解析为多条任务；解析失败的项需逐条标注并允许修正后再次创建
9. 可回退与可编辑：所有 AI 建议均可被用户覆盖，不强制；提交前提供预览与一次性确认
10. 性能与质量：常规解析端到端≤2s（P95≤3s），解析失败率≤5%，异常时提供清晰指引
11. 访问控制与审计：仅有创建权限的用户可调用智能创建；创建行为记录在审计日志中
12. Open-WebUI 集成：
   - 在 Open-WebUI 对话中，用户以自然语言触发“创建任务”意图时，系统返回结构化预览并需用户确认
   - 支持单条与批量创建；创建前需显式确认；成功后返回任务链接/ID 列表
   - 处理鉴权（继承当前用户身份或使用受限服务账号+后端校验）与错误回退（回到表单编辑）
13. 批量上限与幂等：批量创建每次最多 20 条；创建接口接受 `client_token` 幂等键（同一用户+同一 token 的重复请求不得重复落库）

## Tasks / Subtasks

- [ ] 任务创建表单 (AC: 1, 2)
  - [ ] 创建任务创建页面
  - [ ] 实现表单字段验证
  - [ ] 实现日期选择器组件
  - [ ] 实现优先级选择组件
  - [ ] 实现负责人选择组件
- [ ] 任务创建API (AC: 3, 4)
  - [ ] 创建任务创建API端点
  - [ ] 实现数据验证逻辑
  - [ ] 实现数据库保存操作
  - [ ] 实现错误处理机制
- [ ] 前端集成 (AC: 5)
  - [ ] 实现表单提交逻辑
  - [ ] 实现成功反馈显示
  - [ ] 实现任务列表实时更新
  - [ ] 实现错误提示显示
### 新增：智能化创建与 Open-WebUI 集成
- [ ] 自然语言解析服务 (AC: 6, 10)
  - [ ] 规则+轻量 NLP 提取日期/优先级/负责人/标签
  - [ ] 提供 `/api/tasks/parse` 端点，返回结构化字段与不确定项标注
  - [ ] 解析预览与手动修正交互
- [ ] 模板与推荐 (AC: 7)
  - [ ] 常用模板定义与“最近使用”缓存
  - [ ] 提供 `/api/tasks/templates/suggest` 端点（接受项目/标签上下文）
- [ ] 批量创建 (AC: 8, 9)
  - [ ] 多行文本/CSV 粘贴解析；局部失败可编辑重试
  - [ ] 批量创建事务与幂等键支持
- [ ] 批量上限与幂等实现 (AC: 13)
  - [ ] 在 `/api/tasks` 与批量创建逻辑中验证每次≤20条
  - [ ] 支持 `client_token`（幂等键）参数：相同用户+token 重复提交仅返回首次结果
  - [ ] 持久化幂等请求摘要与结果哈希，设置 TTL（例如 24h）
- [ ] Open-WebUI 集成 (AC: 12)
  - [ ] 定义“create_tasks”工具/函数调用 schema（单条与批量）
  - [ ] 鉴权策略：携带用户 JWT 或服务端交换一次性令牌
  - [ ] 对话内预览-确认-落库闭环与错误回退设计
- [ ] 审计与可观测性 (AC: 11)
  - [ ] 记录解析输入摘要、结果、确认者、创建结果ID
  - [ ] 指标：解析耗时、成功率、覆盖率、人工修改率

## Dev Notes

### 任务字段定义
- **标题**: 必填，最大长度100字符
- **描述**: 可选，最大长度500字符
- **负责人**: 必填，从用户列表选择
- **截止日期**: 必填，不能早于当前日期
- **优先级**: 必填，选项：高/中/低
- **状态**: 默认"未开始"

### 数据库表设计
- **tasks表**: id, title, description, assignee_id, due_date, priority, status, created_by, created_at, updated_at

### API端点
- `POST /api/tasks` - 创建新任务
- `GET /api/tasks` - 获取任务列表
- `GET /api/users` - 获取用户列表（用于负责人选择）
#### 新增（智能化相关）
- `POST /api/tasks/parse` - 自然语言解析为任务字段（支持批量），返回结构化建议+不确定项
- `GET /api/tasks/templates/suggest` - 基于上下文返回模板建议
- `POST /api/tasks` - 新增可选参数 `client_token`（字符串，≤64 字节），用于幂等控制；当 body 为数组时表示批量创建，单次数组长度≤20

### 表单验证规则
- 标题不能为空且长度不超过100字符
- 截止日期不能早于当前日期
- 负责人必须从现有用户中选择
- 优先级必须从预定义选项中选择
### AI / NLP 解析规则（MVP）
- 日期：支持“今天/明天/本周五/下周三/月底”与 YYYY-MM-DD
- 优先级：高/中/低，支持同义词（紧急/一般/低）
- 负责人：精确匹配现有用户；未匹配时标为不确定项
- 标题：从句首动词短语抽取；描述：保留剩余文本
- 兜底：无法解析时返回空建议与可编辑表单
### Open-WebUI 集成说明
- 触发方式：用户在 Open-WebUI 中输入自然语言指令；通过工具调用触发后端
- 工具定义（示例，供前端/LLM 参考）：
```json
{
  "type": "function",
  "function": {
    "name": "create_tasks",
    "description": "创建单条或多条任务，支持预解析与用户确认",
    "parameters": {
      "type": "object",
      "properties": {
        "inputs": {
          "type": "array",
          "items": { "type": "string" },
          "description": "自然语言任务文本数组"
        },
        "confirm": { "type": "boolean", "description": "是否直接落库；为 false 时仅返回预览" }
      },
      "required": ["inputs"]
    }
  }
}
```
- 流程：
  1) 解析：Open-WebUI 触发 `create_tasks(confirm=false)` → 后端调用 `/api/tasks/parse`
  2) 预览与确认：返回结构化建议；用户确认或编辑
  3) 创建：确认后触发 `create_tasks(confirm=true)` → 后端落库 `/api/tasks`
  4) 结果：返回任务 ID/链接；失败项单独返回并可再次编辑
### 性能与质量指标
- 解析 P95 ≤ 3s，平均 ≤ 2s；批量（≤20条）P95 ≤ 5s
- 解析失败率 ≤ 5%；人工修改率与建议覆盖率纳入监控
- 明确超时与重试策略；异常时提供回退为表单手动创建

### Testing
- **测试文件位置**: `tests/unit/tasks/`, `tests/integration/tasks/`
- **测试标准**: 表单验证测试、API功能测试
- **测试框架**: pytest + pytest-asyncio
- **测试要求**: 字段验证测试、数据库操作测试、前端交互测试

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-15 | 1.0 | 初始故事创建 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
待开发时填写

### Debug Log References
待开发时填写

### Completion Notes List
待开发时填写

### File List
待开发时填写

## QA Results
待QA审查时填写
